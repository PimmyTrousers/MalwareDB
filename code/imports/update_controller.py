import pymysql
from imports.download_controller import Download_Controller

config = {}
exec(compile(open("imports/keys.py", "rb").read(), "imports/keys.py", 'exec'), config)

class Update_Controller:

    def __init__(self):
        self.mysqldb = pymysql.connect(host=config['host'],
                                       user=config['user'],
                                       passwd=config["password"],
                                       db='MalwareDB')

    def manual_add(self):
        #creates mysql cursor
        with self.mysqldb.cursor() as cursor:
            #input information
            id = self.check_for_id() + 1
            filename = input("insert filename: ")
            architecture = input("input architecture: ")
            lang = input("input lang: ")
            platform = input("input platform: ")
            vip = int(input("input vip: "))
            location = input("input location: ")
            uploader = Download_Controller()
            result = uploader.upload_file(location)
            print("successfully uploaded {}".format(location))

            #converts info to mysql command
            if result is True:
                sql = "insert into malware VALUES(%d, '%s', '%s', '%s', '%s', %d, '%s')" % \
                      (id, filename, architecture, lang, platform, vip, location)
            #executes mysql command
                cursor.execute(sql)
                self.mysqldb.commit()
                return
            print("Unsuccessful upload")
            return

    def check_for_id(self):
        max = 0
        with self.mysqldb.cursor() as cursor:
            cursor.execute("SELECT id FROM malware")
            result = cursor.fetchall()
            for element in result:
                if element[0] > max:
                    max = element[0]
            return max

    def manual_delete(self, name):
        with self.mysqldb.cursor() as cursor:
            cursor.execute("select id from malware where filename like \"{}\"".format(name))
            x = cursor.fetchone()
            cursor.execute("delete from malware where id like {}".format(x[0]))
            self.mysqldb.commit()

        return
